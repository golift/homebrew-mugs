# typed: false
# frozen_string_literal: true

# This file was generated by GoReleaser. DO NOT EDIT.
class Unpoller < Formula
  desc "Polls a UniFi controller, exports metrics to InfluxDB, Prometheus and Datadog"
  homepage "https://unpoller.com/"
  version "2.7.8"
  license "MIT"

  on_macos do
    url "https://github.com/unpoller/unpoller/releases/download/v2.7.8/unpoller_2.7.8_darwin_all.tar.gz"
    sha256 "e11f8e3f6cf1577ae229ec9b33ca74b0241024ff18ffc14d4c8ead9870ff0b79"

    def install
      bin.install "unpoller"
    end
  end

  on_linux do
    if Hardware::CPU.intel?
      url "https://github.com/unpoller/unpoller/releases/download/v2.7.8/unpoller_2.7.8_linux_amd64.tar.gz"
      sha256 "fde60b956ad9a7846e6bc92ca3d9b19f7bf5e47d3c9b221a424d9944715ecdf3"

      def install
        bin.install "unpoller"
      end
    end
    if Hardware::CPU.arm? && Hardware::CPU.is_64_bit?
      url "https://github.com/unpoller/unpoller/releases/download/v2.7.8/unpoller_2.7.8_linux_arm64.tar.gz"
      sha256 "a3ab1f1474dad2523c67c424abda3ddaa224af619bdf985616f2ea2241243de2"

      def install
        bin.install "unpoller"
      end
    end
    if Hardware::CPU.arm? && !Hardware::CPU.is_64_bit?
      url "https://github.com/unpoller/unpoller/releases/download/v2.7.8/unpoller_2.7.8_linux_armv6.tar.gz"
      sha256 "dac4c1500f7902eeedc7a03f35671153c47f098c122a8276b4ee09af9010416a"

      def install
        bin.install "unpoller"
      end
    end
  end

  conflicts_with "unifi-poller"

  def caveats
    <<~EOS
      Edit the config file at #{etc}/unpoller/up.conf then start unpoller with brew services start unpoller ~ log file: #{var}/log/unpoller.log The manual explains the config file options: man unpoller
    EOS
  end

  plist_options startup: false

  def plist
    <<~EOS
      <?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
  <dict>
      <key>Label</key>
      <string>#{plist_name}</string>
      <key>ProgramArguments</key>
      <array>
          <string>#{bin}/unpoller</string>
          <string>--config</string>
          <string>#{etc}/unpoller/up.conf</string>
      </array>
      <key>RunAtLoad</key>
      <true/>
      <key>KeepAlive</key>
      <true/>
      <key>StandardErrorPath</key>
      <string>#{var}/log/unpoller.log</string>
      <key>StandardOutPath</key>
      <string>#{var}/log/unpoller.log</string>
  </dict>
</plist>

    EOS
  end

  test do
    assert_match "unpoller v#{version}", shell_output("#{bin}/unpoller -v 2>&1", 2)
  end
end
